<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Meeting">

	<insert id="insertMeeting">
		<![CDATA[
			INSERT INTO MEETING(ID, MASTER, TITLE, CONTENT, LOCATION, MEETING_DATE, LONGITUDE, LATITUDE, TOTAL_MEMBER)
			VALUES((SELECT NVL(MAX(ID),0) FROM MEETING)+1, #{master}, #{title}, #{content}, #{location}, TO_DATE(#{meeting_date}, 'YYYY-MM-DDHH24:MI'), #{longitude}, #{latitude}, #{total_member})
		]]>
	</insert>
	
	<insert id="insertMeeingJoin">
		<![CDATA[
			INSERT INTO MEETING_JOIN(MEETING_ID, MEMBER_ID)
			VALUES((SELECT NVL(MAX(ID),0) FROM MEETING), #{master})
		]]>
	</insert>
	
	<select id="selectMeeting" resultType="meeting">
		<![CDATA[
			SELECT *
			FROM MEETING
			ORDER BY ID
		]]>
	</select>
	
	<select id="selectJoinedMeetingNotHosting" resultType="meeting">
		<![CDATA[
			SELECT *
			FROM MEETING
			WHERE ID IN (SELECT MEETING_ID FROM MEETING_JOIN WHERE MEMBER_ID = #{member_id})
			AND MASTER <> #{member_id} 
			ORDER BY ID
		]]>
	</select>
	
	<select id="selectJoinedMeeting" resultType="meeting">
		<![CDATA[
			SELECT *
			FROM MEETING
			WHERE ID IN (SELECT MEETING_ID FROM MEETING_JOIN WHERE MEMBER_ID = #{member_id})
			ORDER BY ID
		]]>
	</select>
	
	<select id="selectJoinedMeetingImg" resultType="meeting">
		<![CDATA[
			SELECT U.PROFILE_IMAGE
			FROM MEMBER U, MEETING_JOIN J, MEETING M
			WHERE U.ID = J.MEMBER_ID
			AND J.MEETING_ID = M.ID
			AND M.ID = #{meeting_id}
			ORDER BY MEMBER_ID
		]]>
	</select>
	
	<select id="selectNotJoinedMeeting" resultType="meeting">
		<![CDATA[
			SELECT *
			FROM MEETING
			WHERE ID NOT IN (SELECT MEETING_ID FROM MEETING_JOIN WHERE MEMBER_ID = #{member_id})
			ORDER BY ID
		]]>
	</select>
	
	<select id="selectHostingMeeting" resultType="meeting">
		<![CDATA[
			SELECT *
			FROM MEETING
			WHERE ID IN (SELECT ID FROM MEETING WHERE MASTER = #{member_id})
			ORDER BY ID
		]]>
	</select>
	
	<insert id="joinMeeting">
		<![CDATA[
			INSERT INTO MEETING_JOIN(MEETING_ID, MEMBER_ID)
			VALUES(#{meeting_id}, #{member_id})
		]]>
	</insert>
	
	<update id="joinedMemberCountUp">
		<![CDATA[
			UPDATE MEETING 
			SET JOINED_MEMBER = (SELECT JOINED_MEMBER FROM MEETING WHERE ID = #{meeting_id}) + 1
			WHERE ID = #{meeting_id}
		]]>
	</update>
	
	<delete id="deleteJoin">
		<![CDATA[
			DELETE MEETING_JOIN
			WHERE MEMBER_ID = #{member_id} AND MEETING_ID = #{meeting_id}
		]]>
	</delete>
	
	<update id="deleteJoinCountDown">
		<![CDATA[
			UPDATE MEETING 
			SET JOINED_MEMBER = (SELECT JOINED_MEMBER FROM MEETING WHERE ID = #{meeting_id}) - 1
			WHERE ID = #{meeting_id}
		]]>
	</update>
	
	<update id="updateMeeting">
		<![CDATA[
			UPDATE MEETING 
			SET TITLE = #{title},
				CONTENT = #{content},
				LOCATION = #{location},
				MEETING_DATE = #{meeting_date},
				TOTAL_MEMBER = #{total_member},
				LATITUDE = #{latitude},
				LONGITUDE = #{longitude}
			WHERE ID = #{id}
		]]>
	</update>
	
	<delete id="deleteMeeting">
		<![CDATA[
			DELETE MEETING
			WHERE ID = #{meeting_id}
		]]>
	</delete>
	
</mapper>